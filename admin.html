<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Vue Admin - Edition des horaires (Mobile compact)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#faf7f9; --text:#2b2a2a; --primary:#d81b60; --primary-dark:#a31447;
      --accent:#6a1b9a; --line:#e9d7e5; --card:#ffffff;
      --badge-yellow:#ffd54f; --badge-green:#2e7d32; --badge-red:#c62828;
      --valid-bg:#c8e6c9; --valid-border:#81c784;
      --cell-bg:#faf8fc; --cell-border:#eadff0; --col-head:#f3e3ee;

      /* Tailles (seront diminu√©es en compact) */
      --fs-base:16px; --fs-small:13px; --fs-tiny:12px;
      --pad-cell:1rem; --pad-cell-compact:.45rem;
      --pad-btn:.5rem .9rem; --pad-btn-compact:.35rem .6rem;
      --radius:12px;
    }

    body { font-family: Arial, sans-serif; background: var(--bg); color:var(--text); padding: 2rem; font-size: var(--fs-base); }
    h1 { text-align: center; color:var(--accent); margin-bottom:.25rem; }
    #info-semaine { text-align:center; margin-bottom:1rem; color:#544a5d; }

    .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center; margin:.25rem 0 1rem; }
    .toolbar button {
      padding:var(--pad-btn); border-radius:999px; border:1px solid var(--primary); background:var(--primary); color:#fff; cursor:pointer; transition:.2s;
      box-shadow: 0 4px 12px rgba(216,27,96,.15);
      font-size: var(--fs-small);
    }
    .toolbar button:hover { background:var(--primary-dark); transform: translateY(-1px); }

    /* Tableau */
    table { width: 100%; border-collapse: collapse; background: var(--card); margin-top: 1rem; border:1px solid var(--line); box-shadow: 0 10px 30px rgba(106,27,154,.08); table-layout: fixed; }
    th, td { padding: var(--pad-cell); border: 1px solid var(--line); text-align: center; }
    th { background: var(--col-head); color: #3c2a52; font-size: var(--fs-small); }
    td { font-size: var(--fs-small); }
    select { width: 100%; min-width: 0; margin: 0.2rem 0; padding: 0.45rem; border-radius:10px; border:1px solid var(--line); background:#fff; font-size: var(--fs-small); }
    .statut { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 999px; font-size: var(--fs-tiny); font-weight: bold; }
    .valid√© { background-color: var(--badge-green); color: white; }
    .en-attente { background-color: var(--badge-yellow); color: #4e3b00; }
    .refus√© { background-color: var(--badge-red); color: white; }
    .action-btn { font-size: var(--fs-small); margin: 0.15rem; padding: 0.35rem 0.55rem; border: none; border-radius: 999px; cursor: pointer; }
    .valider-btn { background-color: var(--badge-green); color: white; }
    .refuser-btn { background-color: var(--badge-red); color: white; }
    .total { font-weight: bold; white-space: nowrap; }
    .horaire-group { display: grid; grid-template-columns: 1fr 1fr; gap: .25rem; place-items:center; }

    /* Planning (grille) */
    .planning { margin-top:1rem; }
    .planning .heading { display:flex; align-items:center; justify-content:space-between; margin-bottom:.35rem; }
    .planning h2 { margin:0; color:var(--accent); font-size:1rem; }

    .weekly-grid {
      width:100%;
      border:1px solid var(--cell-border);
      border-radius:var(--radius);
      overflow:hidden;
      background:var(--card);
      box-shadow: 0 10px 30px rgba(106,27,154,.08);
      font-size: var(--fs-small);
    }
    .wg-row { display:grid; grid-template-columns: 110px repeat(5, 1fr); }
    .wg-row.header { background:var(--col-head); font-weight:bold; color:#3c2a52; }
    .wg-cell { border-top:1px solid var(--cell-border); border-right:1px solid var(--cell-border); padding:.45rem .5rem; background:var(--cell-bg); min-height:38px; display:flex; align-items:center; justify-content:center; gap:.25rem; }
    .wg-row .wg-cell:first-child { background:#fff; font-weight:bold; color:#3c2a52; }
    .wg-row .wg-cell:last-child { border-right:none; }
    .pill { display:inline-flex; align-items:center; gap:.35rem; background:var(--valid-bg); border:1px solid var(--valid-border); padding:.2rem .45rem; border-radius:8px; font-weight:600; color:#1b5e20; white-space:nowrap; font-size: var(--fs-tiny); }
    .empty { color:#8b7f92; font-style:italic; }

    /* ===== Mode compact (mobile) ===== */
    .compact body, body.compact { font-size: var(--fs-small); }
    body.compact { padding: .8rem; }
    body.compact th, body.compact td { padding: var(--pad-cell-compact); }
    body.compact .toolbar button { padding: var(--pad-btn-compact); font-size: var(--fs-tiny); }
    body.compact select { padding:.35rem; font-size: var(--fs-tiny); }
    body.compact .wg-row { grid-template-columns: 90px repeat(5, 1fr); }
    body.compact .wg-cell { min-height: 32px; padding:.35rem; }
    body.compact .pill { padding:.15rem .35rem; }

    /* Auto-compact sous 480px */
    @media (max-width: 480px){
      :root{ --fs-base:14px; --fs-small:12px; --fs-tiny:11px; }
      body{ padding: 0.8rem; }
      th, td{ padding: var(--pad-cell-compact); }
      .toolbar button{ padding: var(--pad-btn-compact); }
      .wg-row{ grid-template-columns: 88px repeat(5, 1fr); }
    }
  </style>
</head>
<body>
  <h1>Edition des Horaires</h1>

  <div class="toolbar">
    <button id="prevWeek">‚üµ</button>
    <button id="thisWeek">Cette semaine</button>
    <button id="nextWeek">‚ü∂</button>
    <button id="viderSemaine">Vider (local)</button>
    <button id="toggleCompact" title="Basculer mode compact">üì± Compact</button>
  </div>

  <p id="info-semaine">Chargement...</p>

  <table id="tableau">
    <thead>
      <tr>
        <th>Nom</th>
        <th class="th-jour" data-idx="0">Lundi</th>
        <th class="th-jour" data-idx="1">Mardi</th>
        <th class="th-jour" data-idx="2">Mercredi</th>
        <th class="th-jour" data-idx="3">Jeudi</th>
        <th class="th-jour" data-idx="4">Vendredi</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <section class="planning">
    <div class="heading">
      <h2 id="planning-title">Planning ‚Äî Semaine</h2>
      <small style="color:#6b5b7a">Imprime (Ctrl/Cmd + P)</small>
    </div>
    <div class="weekly-grid" id="planning-grid"></div>
  </section>

  <script>
    /* -------- Helpers -------- */
    const pad = n => String(n).padStart(2,'0');
    const hhmmToMin = s => { const [h,m]=s.split(":").map(Number); return h*60+m; };
    const toHM = mins => `${Math.floor(mins/60)}h${mins%60 ? pad(mins%60) : ""}`;
    const isMobile = () => window.innerWidth <= 480;

    function mondayOf(date){ const d = new Date(date); d.setHours(0,0,0,0); const day = d.getDay(); const diff = (day===0?-6:1-day); d.setDate(d.getDate()+diff); return d; }
    function weekKeyFromMonday(mon){ return `${mon.getFullYear()}-${pad(mon.getMonth()+1)}-${pad(mon.getDate())}`; }
    function addDays(d,n){ const x=new Date(d); x.setDate(d.getDate()+n); return x; }
    function addWeeks(d,n){ return addDays(d,7*n); }
    function labelSemaine(mon){ const ven=new Date(mon); ven.setDate(mon.getDate()+4); return `üìÖ du ${mon.toLocaleDateString('fr-FR')} au ${ven.toLocaleDateString('fr-FR')}`; }

    function joursLabels() {
      return isMobile() ? ["Lun","Mar","Mer","Jeu","Ven"] : ["Lundi","Mardi","Mercredi","Jeudi","Vendredi"];
    }

    /* -------- Storage -------- */
    const LS_KEY = "disponibilites_local";
    const readAll = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)||"{}"); } catch { return {}; } };
    const writeAll = (obj) => localStorage.setItem(LS_KEY, JSON.stringify(obj));

    /* -------- UI refs -------- */
    const infoSemaine = document.getElementById("info-semaine");
    const tbody = document.querySelector("#tableau tbody");
    const planningTitle = document.getElementById("planning-title");
    const planningGrid = document.getElementById("planning-grid");

    /* -------- Semaine courante -------- */
    let currentMonday = mondayOf(new Date());
    let currentWeekKey = weekKeyFromMonday(currentMonday);

    let jours = ["Lundi","Mardi","Mercredi","Jeudi","Vendredi"];
    const heures = ["--", "10:00","10:15","10:30","10:45","11:00","11:15","11:30","11:45","12:00","12:15","12:30","12:45","13:00","13:15","13:30"];

    function refreshInfo(){
      infoSemaine.textContent = labelSemaine(currentMonday);
      const ven = addDays(currentMonday,4);
      planningTitle.textContent = `Planning valid√© ‚Äî du ${currentMonday.toLocaleDateString('fr-FR')} au ${ven.toLocaleDateString('fr-FR')}`;
      // Mettre √† jour l'en-t√™te du tableau (abr√©ger en mobile)
      document.querySelectorAll(".th-jour").forEach(th=>{
        const idx = Number(th.dataset.idx);
        th.textContent = joursLabels()[idx];
      });
      jours = joursLabels().map(s=>{
        // pour la logique interne on garde le mappage long vs court
        // mais les cl√©s restent "Lundi..Vendredi" en interne; ici on n'utilise que l'affichage
        return s; // affichage
      });
    }

    /* -------- Navigation -------- */
    document.getElementById("prevWeek").addEventListener("click", ()=>{ currentMonday=addWeeks(currentMonday,-1); currentWeekKey=weekKeyFromMonday(currentMonday); renderAll(); });
    document.getElementById("nextWeek").addEventListener("click", ()=>{ currentMonday=addWeeks(currentMonday, 1); currentWeekKey=weekKeyFromMonday(currentMonday); renderAll(); });
    document.getElementById("thisWeek").addEventListener("click", ()=>{ currentMonday=mondayOf(new Date()); currentWeekKey=weekKeyFromMonday(currentMonday); renderAll(); });

    /* -------- Calculs -------- */
    function calculHeure(debut, fin) { if (!debut || !fin || debut==="--"||fin==="--") return 0; return hhmmToMin(fin) - hhmmToMin(debut); }
    function createSelects(debut, fin, userKey, jour) {
      const opts = heures.map(h => `<option value="${h}" ${h===debut?'selected':''}>${h}</option>`).join('');
      const opts2= heures.map(h => `<option value="${h}" ${h===fin  ?'selected':''}>${h}</option>`).join('');
      return `
        <div class="horaire-group">
          <select aria-label="D√©but" data-role="debut" data-user="${userKey}" data-jour="${jour}">${opts}</select>
          <select aria-label="Fin"   data-role="fin"   data-user="${userKey}" data-jour="${jour}">${opts2}</select>
        </div>`;
    }

    /* -------- D√©l√©gation d'√©v√©nements -------- */
    tbody.addEventListener("change", (e)=>{
      const sel = e.target;
      if (sel.matches("select[data-role]")){
        const role = sel.getAttribute("data-role");
        const userKey = sel.getAttribute("data-user");
        const jour = sel.getAttribute("data-jour");
        updateHeure(userKey, jour, role, sel.value);
      }
    });
    tbody.addEventListener("click", (e)=>{
      const vb = e.target.closest(".valider-btn");
      const rb = e.target.closest(".refuser-btn");
      if (vb){ valider(vb.dataset.user, vb.dataset.jour); }
      if (rb){ refuser(rb.dataset.user, rb.dataset.jour); }
    });

    function updateHeure(userKey, jour, type, value){
      const all = readAll();
      const rec = all?.[currentWeekKey]?.[userKey];
      if (!rec) return;
      if (!rec.jours) rec.jours={};
      if (!rec.jours[jour]) rec.jours[jour] = { statut:"en-attente" };
      rec.jours[jour][type] = value;
      writeAll(all);
      renderAll();
    }
    function valider(userKey, jour){
      const all = readAll();
      const rec = all?.[currentWeekKey]?.[userKey];
      if (!rec) return;
      if (!rec.jours?.[jour]) rec.jours[jour] = {};
      rec.jours[jour].statut = "valid√©";
      writeAll(all); renderAll();
    }
    function refuser(userKey, jour){
      const all = readAll();
      const rec = all?.[currentWeekKey]?.[userKey];
      if (!rec) return;
      if (!rec.jours?.[jour]) rec.jours[jour] = {};
      rec.jours[jour].statut = "refus√©";
      writeAll(all); renderAll();
    }

    /* -------- Rendu principal + planning -------- */
    function renderAll(){
      refreshInfo();

      const all = readAll();
      const semaine = all[currentWeekKey] || {};

      tbody.innerHTML = "";
      const lignes = {};
      Object.keys(semaine).forEach(key=>{
        const rec = semaine[key];
        const prenom = (rec.prenom||key).trim();
        if (!lignes[prenom]) lignes[prenom] = { key, jours: rec.jours||{} };
      });
      const prenomsTries = Object.keys(lignes).sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));

      const joursRefs = ["Lundi","Mardi","Mercredi","Jeudi","Vendredi"]; // cl√©s internes stables
      const joursAff = joursLabels(); // affichage (abr√©g√© en mobile)

      for (const prenom of prenomsTries){
        const obj = lignes[prenom];
        const tr = document.createElement("tr");
        tr.innerHTML = `<td style="font-weight:600">${prenom}</td>`;
        let totalValide = 0;
        for (let i=0;i<5;i++){
          const J = joursRefs[i]; // cl√©
          const hj = obj.jours?.[J];
          const td = document.createElement("td");
          const btnOK = `<button class='action-btn valider-btn' title="Valider" data-user="${obj.key}" data-jour="${J}">‚úÖ</button>`;
          const btnKO = `<button class='action-btn refuser-btn' title="Refuser" data-user="${obj.key}" data-jour="${J}">‚úñÔ∏è</button>`;

          if (hj && hj.debut && hj.fin){
            const statut = hj.statut || "en-attente";
            if (statut === "valid√©"){
              const d = calculHeure(hj.debut, hj.fin);
              if (d>0) totalValide += d;
            }
            td.innerHTML = `
              ${createSelects(hj.debut, hj.fin, obj.key, J)}
              <div class="statut ${statut}">${statut}</div>
              <div>${btnOK}${btnKO}</div>
            `;
          } else {
            td.innerHTML = `
              ${createSelects("--", "--", obj.key, J)}
              <div class="statut en-attente">en-attente</div>
              <div>${btnOK}${btnKO}</div>
            `;
          }
          tr.appendChild(td);
        }
        tr.innerHTML += `<td class="total">${toHM(totalValide)}</td>`;
        tbody.appendChild(tr);
      }

      /* ---- Planning valid√© (grille) ---- */
      const dates = joursRefs.map((_,i)=> {
        const d = addDays(currentMonday, i);
        return `${d.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit' })}`;
      });

      const rows = prenomsTries;
      const getCellContent = (prenom) => {
        const { key, jours:jj } = lignes[prenom] || {};
        return joursRefs.map(j=>{
          const h = jj?.[j];
          if (h?.statut === "valid√©" && h.debut && h.fin){
            return `<span class="pill">${h.debut}‚Äì${h.fin}</span>`;
          }
          return `<span class="empty">‚Äî</span>`;
        });
      };

      let gridHTML = '';
      gridHTML += `<div class="wg-row header">
        <div class="wg-cell">Perso</div>
        ${joursAff.map((j,idx)=>`<div class="wg-cell">${j}<br><small>${dates[idx]}</small></div>`).join('')}
      </div>`;

      for (const prenom of rows){
        const cells = getCellContent(prenom);
        gridHTML += `<div class="wg-row">
          <div class="wg-cell">${prenom}</div>
          ${cells.map(c=>`<div class="wg-cell">${c}</div>`).join('')}
        </div>`;
      }

      if (rows.length === 0){
        gridHTML += `<div class="wg-row"><div class="wg-cell">‚Äî</div>${joursRefs.map(()=>`<div class="wg-cell empty">Aucune donn√©e</div>`).join('')}</div>`;
      }

      planningGrid.innerHTML = gridHTML;
    }

    /* -------- Vider semaine -------- */
    document.getElementById("viderSemaine").addEventListener("click", ()=>{
      const all = readAll();
      if (all[currentWeekKey]) {
        if (confirm("Supprimer toutes les donn√©es de cette semaine ?")) {
          delete all[currentWeekKey];
          writeAll(all);
          renderAll();
        }
      } else alert("Aucune donn√©e pour cette semaine.");
    });

    /* -------- Mode compact -------- */
    const applyCompact = () => {
      if (isMobile()) document.body.classList.add("compact");
      else document.body.classList.remove("compact");
    };
    applyCompact();
    window.addEventListener("resize", ()=>{ applyCompact(); renderAll(); });

    document.getElementById("toggleCompact").addEventListener("click", ()=>{
      document.body.classList.toggle("compact");
      renderAll();
    });

    // init
    renderAll();
  </script>
</body>
</html>

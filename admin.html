<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Vue Admin - Edition des horaires (Local)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#faf7f9; --text:#2b2a2a; --primary:#d81b60; --primary-dark:#a31447;
      --accent:#6a1b9a; --line:#e9d7e5; --card:#ffffff;
      --badge-yellow:#ffd54f; --badge-green:#2e7d32; --badge-red:#c62828;
    }
    body { font-family: Arial, sans-serif; background: var(--bg); color:var(--text); padding: 2rem; }
    h1, #info-semaine { text-align: center; }
    h1 { color:var(--accent); }
    .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center; margin:.25rem 0 1rem; }
    .toolbar button {
      padding:.5rem .9rem; border-radius:999px; border:1px solid var(--primary); background:var(--primary); color:#fff; cursor:pointer; transition:.2s;
      box-shadow: 0 4px 12px rgba(216,27,96,.15);
    }
    .toolbar button:hover { background:var(--primary-dark); transform: translateY(-1px); }
    table { width: 100%; border-collapse: collapse; background: var(--card); margin-top: 1rem; border:1px solid var(--line); box-shadow: 0 10px 30px rgba(106,27,154,.08); }
    th, td { padding: 1rem; border: 1px solid var(--line); text-align: center; }
    th { background: #f3e3ee; color: #3c2a52; }
    select { margin: 0.3rem 0.2rem; padding: 0.6rem; border-radius:10px; border:1px solid var(--line); }
    .statut { display: inline-block; padding: 0.35rem 0.65rem; border-radius: 999px; font-size: 0.85rem; font-weight: bold; }
    .valid√© { background-color: var(--badge-green); color: white; }
    .en-attente { background-color: var(--badge-yellow); color: #4e3b00; }
    .refus√© { background-color: var(--badge-red); color: white; }
    .action-btn { font-size: 0.75rem; margin: 0.2rem; padding: 0.35rem 0.6rem; border: none; border-radius: 999px; cursor: pointer; }
    .valider-btn { background-color: var(--badge-green); color: white; }
    .refuser-btn { background-color: var(--badge-red); color: white; }
    .total { font-weight: bold; }
    .horaire-group { display: flex; justify-content: center; align-items: center; gap: 0.25rem; margin-bottom: 0.5rem; }
    /* Planning valid√© */
    .planning { margin-top:2rem; background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow: 0 10px 30px rgba(106,27,154,.08); }
    .planning header { padding:1rem 1.25rem; border-bottom:1px solid var(--line); color:var(--accent); font-weight:bold; }
    .planning .grid { display:grid; grid-template-columns: 120px 1fr; }
    .planning .day { border-top:1px solid var(--line); padding: .85rem 1.25rem; display:flex; gap:1rem; }
    .planning .day:first-child { border-top:none; }
    .planning .day h3 { width:120px; margin:0; color:#3c2a52; }
    .planning .slots { display:flex; flex-wrap:wrap; gap:.5rem; }
    .planning .slot { background:#f7eef5; border:1px solid #eed5ea; padding:.35rem .6rem; border-radius:999px; }
    /* Impression : n'imprimer que le planning */
    @media print{
      body{ background:#fff; padding:0; }
      .toolbar, table, #info-semaine, h1 { display:none !important; }
      .planning{ box-shadow:none; border:none; }
      .planning header{ border:none; }
    }
  </style>
</head>
<body>
  <h1>Tableau Admin - Edition des Horaires</h1>

  <div class="toolbar">
    <button id="prevWeek">‚üµ Semaine pr√©c√©dente</button>
    <button id="thisWeek">Cette semaine</button>
    <button id="nextWeek">Semaine suivante ‚ü∂</button>
    <button id="viderSemaine">Vider cette semaine (local)</button>
  </div>

  <p id="info-semaine">Chargement...</p>

  <table id="tableau">
    <thead>
      <tr>
        <th>Pr√©nom</th>
        <th>Lundi</th>
        <th>Mardi</th>
        <th>Mercredi</th>
        <th>Jeudi</th>
        <th>Vendredi</th>
        <th>Total valid√©</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Planning valid√© (vue compacte, imprimable) -->
  <section class="planning" id="planning">
    <header id="planning-title">Planning valid√© ‚Äî Semaine</header>
    <div class="grid" id="planning-grid">
      <!-- rempli en JS -->
    </div>
  </section>

  <script>
    /* -------- Helpers -------- */
    const pad = n => String(n).padStart(2,'0');
    const hhmmToMin = s => { const [h,m]=s.split(":").map(Number); return h*60+m; };
    const toHM = mins => `${Math.floor(mins/60)} h${mins%60 ? " " + pad(mins%60) : ""}`.replace(" 00","");
    function mondayOf(date){ const d = new Date(date); d.setHours(0,0,0,0); const day = d.getDay(); const diff = (day===0?-6:1-day); d.setDate(d.getDate()+diff); return d; }
    function weekKeyFromMonday(mon){ return `${mon.getFullYear()}-${pad(mon.getMonth()+1)}-${pad(mon.getDate())}`; }
    function addDays(d,n){ const x=new Date(d); x.setDate(d.getDate()+n); return x; }
    function addWeeks(d,n){ return addDays(d,7*n); }
    function labelSemaine(mon){ const ven=new Date(mon); ven.setDate(mon.getDate()+4); return `üìÖ du ${mon.toLocaleDateString('fr-FR')} au ${ven.toLocaleDateString('fr-FR')}`; }

    /* -------- Normalisation noms -------- */
    function normalizeKey(name){
      return name.trim().replace(/\s+/g,' ').toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    }

    /* -------- Storage -------- */
    const LS_KEY = "disponibilites_local";
    const readAll = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)||"{}"); } catch { return {}; } };
    const writeAll = (obj) => localStorage.setItem(LS_KEY, JSON.stringify(obj));

    /* -------- UI refs -------- */
    const infoSemaine = document.getElementById("info-semaine");
    const tbody = document.querySelector("#tableau tbody");
    const planningTitle = document.getElementById("planning-title");
    const planningGrid = document.getElementById("planning-grid");

    /* -------- Semaine courante -------- */
    let currentMonday = mondayOf(new Date());
    let currentWeekKey = weekKeyFromMonday(currentMonday);

    const jours = ["Lundi","Mardi","Mercredi","Jeudi","Vendredi"];
    const heures = ["--"];
    for (let h=10; h<=13; h++){ for (let m of [0,15,30,45]){ if (h===13 && m>30) break; heures.push(`${pad(h)}:${pad(m)}`); } }

    function refreshInfo(){
      infoSemaine.textContent = labelSemaine(currentMonday);
      const ven = addDays(currentMonday,4);
      planningTitle.textContent = `Planning valid√© ‚Äî du ${currentMonday.toLocaleDateString('fr-FR')} au ${ven.toLocaleDateString('fr-FR')}`;
    }

    /* -------- Navigation -------- */
    document.getElementById("prevWeek").addEventListener("click", ()=>{ currentMonday=addWeeks(currentMonday,-1); currentWeekKey=weekKeyFromMonday(currentMonday); refreshInfo(); chargerTableau(); });
    document.getElementById("nextWeek").addEventListener("click", ()=>{ currentMonday=addWeeks(currentMonday, 1); currentWeekKey=weekKeyFromMonday(currentMonday); refreshInfo(); chargerTableau(); });
    document.getElementById("thisWeek").addEventListener("click", ()=>{ currentMonday=mondayOf(new Date()); currentWeekKey=weekKeyFromMonday(currentMonday); refreshInfo(); chargerTableau(); });

    /* -------- Calculs -------- */
    function calculHeure(debut, fin) {
      if (!debut || !fin || debut==="--"||fin==="--") return 0;
      return hhmmToMin(fin) - hhmmToMin(debut);
    }

    function createSelects(debut, fin, userKey, jour) {
      const opts = heures.map(h => `<option value="${h}" ${h===debut?'selected':''}>${h}</option>`).join('');
      const opts2= heures.map(h => `<option value="${h}" ${h===fin  ?'selected':''}>${h}</option>`).join('');
      return `
        <div class="horaire-group">
          <select data-role="debut" data-user="${userKey}" data-jour="${jour}">${opts}</select>
          <select data-role="fin"   data-user="${userKey}" data-jour="${jour}">${opts2}</select>
        </div>`;
    }

    /* -------- D√©l√©gation d'√©v√©nements -------- */
    tbody.addEventListener("change", (e)=>{
      const sel = e.target;
      if (sel.matches("select[data-role]")){
        const role = sel.getAttribute("data-role");
        const userKey = sel.getAttribute("data-user");
        const jour = sel.getAttribute("data-jour");
        updateHeure(userKey, jour, role, sel.value);
      }
    });
    tbody.addEventListener("click", (e)=>{
      const vb = e.target.closest(".valider-btn");
      const rb = e.target.closest(".refuser-btn");
      if (vb){ valider(vb.dataset.user, vb.dataset.jour); }
      if (rb){ refuser(rb.dataset.user, rb.dataset.jour); }
    });

    function updateHeure(userKey, jour, type, value){
      const all = readAll();
      const rec = all?.[currentWeekKey]?.[userKey];
      if (!rec) return;
      if (!rec.jours) rec.jours={};
      if (!rec.jours[jour]) rec.jours[jour] = { statut:"en-attente" };
      rec.jours[jour][type] = value;
      writeAll(all);
      chargerTableau();
    }

    function valider(userKey, jour){
      const all = readAll();
      const rec = all?.[currentWeekKey]?.[userKey];
      if (!rec) return;
      if (!rec.jours?.[jour]) rec.jours[jour] = {};
      rec.jours[jour].statut = "valid√©";
      writeAll(all); chargerTableau();
    }
    function refuser(userKey, jour){
      const all = readAll();
      const rec = all?.[currentWeekKey]?.[userKey];
      if (!rec) return;
      if (!rec.jours?.[jour]) rec.jours[jour] = {};
      rec.jours[jour].statut = "refus√©";
      writeAll(all); chargerTableau();
    }

    /* -------- Rendu principal + planning -------- */
    function chargerTableau(){
      tbody.innerHTML = "";
      refreshInfo();

      const all = readAll();
      const semaine = all[currentWeekKey] || {};
      const lignes = {};

      Object.keys(semaine).forEach(key=>{
        const rec = semaine[key];
        const prenom = (rec.prenom||key).trim();
        if (!lignes[prenom]) lignes[prenom] = { key, jours: rec.jours||{} };
      });

      const prenomsTries = Object.keys(lignes).sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
      for (const prenom of prenomsTries){
        const obj = lignes[prenom];
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${prenom}</td>`;
        let totalValide = 0;

        for (const jour of jours){
          const hj = obj.jours?.[jour];
          const td = document.createElement("td");
          if (hj && hj.debut && hj.fin){
            const statut = hj.statut || "en-attente";
            if (statut === "valid√©"){
              const d = calculHeure(hj.debut, hj.fin);
              if (d>0) totalValide += d;
            }
            td.innerHTML = `
              ${createSelects(hj.debut, hj.fin, obj.key, jour)}
              <div class="statut ${statut}">${statut}</div>
              <button class='action-btn valider-btn' data-user="${obj.key}" data-jour="${jour}">Valider</button>
              <button class='action-btn refuser-btn' data-user="${obj.key}" data-jour="${jour}">Refuser</button>
            `;
          } else {
            td.innerHTML = `
              ${createSelects("--", "--", obj.key, jour)}
              <div class="statut en-attente">en-attente</div>
              <button class='action-btn valider-btn' data-user="${obj.key}" data-jour="${jour}">Valider</button>
              <button class='action-btn refuser-btn' data-user="${obj.key}" data-jour="${jour}">Refuser</button>
            `;
          }
          tr.appendChild(td);
        }
        tr.innerHTML += `<td class="total">${toHM(totalValide)}</td>`;
        tbody.appendChild(tr);
      }

      // ---- Planning valid√© (vue compacte)
      // Regrouper par jour uniquement les cr√©neaux valid√©s, tri√©s par d√©but
      const planning = { Lundi:[],Mardi:[],Mercredi:[],Jeudi:[],Vendredi:[] };
      Object.keys(semaine).forEach(key=>{
        const { prenom, jours:jj } = semaine[key];
        for (const j of Object.keys(planning)){
          const h = jj?.[j];
          if (h?.statut === "valid√©" && h.debut && h.fin){
            planning[j].push({ prenom, debut:h.debut, fin:h.fin, start:hhmmToMin(h.debut) });
          }
        }
      });
      for (const j of Object.keys(planning)){
        planning[j].sort((a,b)=>a.start-b.start || a.prenom.localeCompare(b.prenom,'fr',{sensitivity:'base'}));
      }

      planningGrid.innerHTML = "";
      for (const j of ["Lundi","Mardi","Mercredi","Jeudi","Vendredi"]){
        const dayEl = document.createElement("div");
        dayEl.className = "day";
        dayEl.innerHTML = `<h3>${j}</h3><div class="slots">${
          planning[j].length
            ? planning[j].map(x=>`<span class="slot">${x.prenom} ‚Äî ${x.debut}‚Äì${x.fin}</span>`).join("")
            : `<em>Aucun cr√©neau valid√©</em>`
        }</div>`;
        planningGrid.appendChild(dayEl);
      }
    }

    /* -------- Vider semaine -------- */
    document.getElementById("viderSemaine").addEventListener("click", ()=>{
      const all = readAll();
      if (all[currentWeekKey]) {
        if (confirm("Supprimer toutes les donn√©es de cette semaine (local) ?")) {
          delete all[currentWeekKey];
          writeAll(all);
          chargerTableau();
        }
      } else alert("Aucune donn√©e locale pour cette semaine.");
    });

    // init
    chargerTableau();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Edition des Horaires — Compact</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#fbf8fc; --text:#222; --primary:#d81b60; --line:#ebdfec; --card:#fff;
      --badge-y:#ffd54f; --badge-g:#2e7d32; --badge-r:#c62828;
      --valid-bg:#c8e6c9; --valid-border:#81c784; --col-head:#f3e3ee;
      --fs:13px; --fs-s:12px; --fs-xs:11px;
    }
    /* GLOBAL COMPACT */
    html,body{height:100%}
    body{margin:0; padding:.7rem; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; font-size:var(--fs); background:var(--bg); color:var(--text);}
    h1{margin:.2rem 0 .4rem; font-size:16px; text-align:center; color:#6a1b9a; font-weight:700}
    #info-semaine{margin:.2rem 0 .6rem; text-align:center; color:#6b5b7a; font-size:var(--fs-s)}

    .toolbar{display:flex; gap:.35rem; justify-content:center; flex-wrap:wrap; margin:.2rem 0 .6rem}
    .toolbar button{
      padding:.3rem .55rem; border-radius:999px; border:1px solid var(--primary);
      background:var(--primary); color:#fff; font-size:var(--fs-s); cursor:pointer
    }

    /* TABLE COMPACT */
    table{width:100%; border-collapse:collapse; background:var(--card); border:1px solid var(--line); table-layout:fixed}
    th,td{border:1px solid var(--line); padding:.38rem; text-align:center; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    th{background:var(--col-head); color:#3c2a52; font-size:var(--fs-s)}
    td{font-size:var(--fs-s)}
    th:first-child, td:first-child{width:84px}   /* col prénom étroite */
    th:last-child, td:last-child{width:54px}     /* col total étroite */

    select{width:100%; min-width:0; padding:.28rem; border-radius:8px; border:1px solid var(--line); font-size:var(--fs-xs)}
    .horaire-group{display:grid; grid-template-columns:1fr 1fr; gap:.2rem}
    .statut{display:inline-block; margin-top:.15rem; padding:.15rem .4rem; border-radius:999px; font-size:10px; font-weight:700}
    .validé{background:var(--badge-g); color:#fff}
    .en-attente{background:var(--badge-y); color:#4e3b00}
    .refusé{background:var(--badge-r); color:#fff}
    .action-btn{border:none; border-radius:8px; padding:.18rem .28rem; font-size:12px; cursor:pointer}
    .valider-btn{background:#e8f5e9}
    .refuser-btn{background:#fdecea}
    .total{font-weight:700; font-size:var(--fs-s)}

    /* PLANNING COMPACT */
    .planning{margin:.7rem 0}
    .planning .heading{display:flex; justify-content:space-between; align-items:center; font-size:var(--fs-s); margin-bottom:.3rem}
    .planning h2{margin:0; font-size:14px; color:#6a1b9a}
    .weekly-grid{width:100%; border:1px solid var(--line); border-radius:12px; overflow:hidden; background:var(--card)}
    .wg-row{display:grid; grid-template-columns:90px repeat(5,1fr)}
    .wg-row.header{background:var(--col-head); color:#3c2a52; font-weight:700}
    .wg-cell{border-top:1px solid var(--line); border-right:1px solid var(--line); padding:.35rem; font-size:var(--fs-s); display:flex; justify-content:center; align-items:center}
    .wg-row .wg-cell:last-child{border-right:none}
    .pill{display:inline-flex; align-items:center; padding:.12rem .32rem; border-radius:7px; border:1px solid var(--valid-border); background:var(--valid-bg); font-size:10px; font-weight:700; white-space:nowrap}
    .empty{color:#8b7f92; font-style:italic; font-size:10px}

    /* Impression : que la grille */
    @media print{
      body{padding:0; background:#fff}
      .toolbar, #tableau, #info-semaine, h1{display:none!important}
    }
  </style>
</head>
<body>
  <h1>Edition des Horaires</h1>

  <div class="toolbar">
    <button id="prevWeek">⟵</button>
    <button id="thisWeek">Cette semaine</button>
    <button id="nextWeek">⟶</button>
    <button id="viderSemaine">Vider (local)</button>
  </div>

  <p id="info-semaine">Chargement…</p>

  <!-- Tableau compact -->
  <table id="tableau">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Lun</th>
        <th>Mar</th>
        <th>Mer</th>
        <th>Jeu</th>
        <th>Ven</th>
        <th>Tot</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Planning compact -->
  <section class="planning">
    <div class="heading">
      <h2 id="planning-title">Planning validé</h2>
      <small style="color:#6b5b7a">Imprimer (Ctrl/Cmd + P)</small>
    </div>
    <div class="weekly-grid" id="planning-grid"></div>
  </section>

  <script>
    /* ===== Helpers ===== */
    const pad = n => String(n).padStart(2,'0');
    const hhmmToMin = s => { const [h,m]=s.split(":").map(Number); return h*60+m; };
    const toHM = mins => `${Math.floor(mins/60)}h${mins%60 ? pad(mins%60) : ""}`;
    function mondayOf(date){ const d=new Date(date); d.setHours(0,0,0,0); const day=d.getDay(); d.setDate(d.getDate()+(day===0?-6:1-day)); return d; }
    function addDays(d,n){ const x=new Date(d); x.setDate(d.getDate()+n); return x; }
    function addWeeks(d,n){ return addDays(d,7*n); }
    function weekKeyFromMonday(mon){ return `${mon.getFullYear()}-${pad(mon.getMonth()+1)}-${pad(mon.getDate())}`; }
    function labelSemaine(mon){ const ven=new Date(mon); ven.setDate(mon.getDate()+4); return `du ${mon.toLocaleDateString('fr-FR')} au ${ven.toLocaleDateString('fr-FR')}`; }

    /* ===== Local storage ===== */
    const LS_KEY = "disponibilites_local";
    const readAll = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)||"{}"); } catch { return {}; } };
    const writeAll = (obj) => localStorage.setItem(LS_KEY, JSON.stringify(obj));

    /* ===== UI refs ===== */
    const infoSemaine = document.getElementById("info-semaine");
    const tbody = document.querySelector("#tableau tbody");
    const planningTitle = document.getElementById("planning-title");
    const planningGrid = document.getElementById("planning-grid");

    /* ===== State ===== */
    let currentMonday = mondayOf(new Date());
    let currentWeekKey = weekKeyFromMonday(currentMonday);
    const joursRefs = ["Lundi","Mardi","Mercredi","Jeudi","Vendredi"];   // clés data
    const joursAff  = ["Lun","Mar","Mer","Jeu","Ven"];                   // affichage compact
    const heures = ["--","10:00","10:15","10:30","10:45","11:00","11:15","11:30","11:45","12:00","12:15","12:30","12:45","13:00","13:15","13:30"];

    /* ===== Nav ===== */
    document.getElementById("prevWeek").onclick = ()=>{ currentMonday=addWeeks(currentMonday,-1); currentWeekKey=weekKeyFromMonday(currentMonday); renderAll(); };
    document.getElementById("nextWeek").onclick = ()=>{ currentMonday=addWeeks(currentMonday, 1); currentWeekKey=weekKeyFromMonday(currentMonday); renderAll(); };
    document.getElementById("thisWeek").onclick = ()=>{ currentMonday=mondayOf(new Date()); currentWeekKey=weekKeyFromMonday(currentMonday); renderAll(); };

    /* ===== Logic ===== */
    function calculHeure(debut, fin){ if (!debut||!fin||debut==="--"||fin==="--") return 0; return hhmmToMin(fin)-hhmmToMin(debut); }
    function createSelects(debut, fin, userKey, jour){
      const opts = heures.map(h=>`<option value="${h}" ${h===debut?'selected':''}>${h}</option>`).join('');
      const opts2= heures.map(h=>`<option value="${h}" ${h===fin  ?'selected':''}>${h}</option>`).join('');
      return `<div class="horaire-group">
        <select aria-label="Début" data-role="debut" data-user="${userKey}" data-jour="${jour}">${opts}</select>
        <select aria-label="Fin"   data-role="fin"   data-user="${userKey}" data-jour="${jour}">${opts2}</select>
      </div>`;
    }

    tbody.addEventListener("change", (e)=>{
      const sel = e.target;
      if (!sel.matches("select[data-role]")) return;
      const role = sel.getAttribute("data-role");
      const userKey = sel.getAttribute("data-user");
      const jour = sel.getAttribute("data-jour");
      const all = readAll();
      const rec = all?.[currentWeekKey]?.[userKey]; if (!rec) return;
      if (!rec.jours) rec.jours={};
      if (!rec.jours[jour]) rec.jours[jour]={statut:"en-attente"};
      rec.jours[jour][role] = sel.value;
      writeAll(all); renderAll();
    });
    tbody.addEventListener("click", (e)=>{
      const vb = e.target.closest(".valider-btn");
      const rb = e.target.closest(".refuser-btn");
      if (vb||rb){
        const all = readAll();
        const userKey = (vb||rb).dataset.user;
        const jour = (vb||rb).dataset.jour;
        const rec = all?.[currentWeekKey]?.[userKey]; if (!rec) return;
        if (!rec.jours) rec.jours={};
        if (!rec.jours[jour]) rec.jours[jour]={};
        rec.jours[jour].statut = vb ? "validé" : "refusé";
        writeAll(all); renderAll();
      }
    });

    /* ===== Render ===== */
    function refreshInfo(){
      infoSemaine.textContent = labelSemaine(currentMonday);
      const ven = addDays(currentMonday,4);
      planningTitle.textContent = `Planning validé — du ${currentMonday.toLocaleDateString('fr-FR')} au ${ven.toLocaleDateString('fr-FR')}`;
    }

    function renderAll(){
      refreshInfo();
      const all = readAll();
      const semaine = all[currentWeekKey] || {};

      tbody.innerHTML = "";
      const lignes = {};
      Object.keys(semaine).forEach(key=>{
        const rec = semaine[key];
        const prenom = (rec.prenom||key).trim();
        if (!lignes[prenom]) lignes[prenom] = { key, jours: rec.jours||{} };
      });
      const prenomsTries = Object.keys(lignes).sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));

      for (const prenom of prenomsTries){
        const obj = lignes[prenom];
        const tr = document.createElement("tr");
        tr.innerHTML = `<td style="font-weight:600">${prenom}</td>`;
        let totalValide = 0;
        for (let i=0;i<5;i++){
          const J = joursRefs[i];
          const hj = obj.jours?.[J];
          const td = document.createElement("td");
          const btnOK = `<button class="action-btn valider-btn" title="Valider" data-user="${obj.key}" data-jour="${J}">✅</button>`;
          const btnKO = `<button class="action-btn refuser-btn" title="Refuser" data-user="${obj.key}" data-jour="${J}">✖️</button>`;
          if (hj && hj.debut && hj.fin){
            const statut = hj.statut || "en-attente";
            if (statut==="validé"){ const d = calculHeure(hj.debut, hj.fin); if (d>0) totalValide+=d; }
            td.innerHTML = `${createSelects(hj.debut, hj.fin, obj.key, J)}<div class="statut ${statut}">${statut}</div><div>${btnOK}${btnKO}</div>`;
          } else {
            td.innerHTML = `${createSelects("--","--",obj.key,J)}<div class="statut en-attente">en-attente</div><div>${btnOK}${btnKO}</div>`;
          }
          tr.appendChild(td);
        }
        tr.innerHTML += `<td class="total">${toHM(totalValide)}</td>`;
        tbody.appendChild(tr);
      }

      /* Planning compact */
      const dates = joursRefs.map((_,i)=> {
        const d = addDays(currentMonday, i);
        return `${d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'})}`;
      });
      const rows = prenomsTries;
      const getCellContent = (prenom) => {
        const { key, jours:jj } = lignes[prenom] || {};
        return joursRefs.map(j=>{
          const h = jj?.[j];
          if (h?.statut==="validé" && h.debut && h.fin) return `<span class="pill">${h.debut}–${h.fin}</span>`;
          return `<span class="empty">—</span>`;
        });
      };

      let gridHTML = `<div class="wg-row header">
        <div class="wg-cell">Perso</div>
        ${["Lun","Mar","Mer","Jeu","Ven"].map((j,idx)=>`<div class="wg-cell">${j}<br><small>${dates[idx]}</small></div>`).join('')}
      </div>`;
      for (const prenom of rows){
        const cells = getCellContent(prenom);
        gridHTML += `<div class="wg-row"><div class="wg-cell">${prenom}</div>${cells.map(c=>`<div class="wg-cell">${c}</div>`).join('')}</div>`;
      }
      if (rows.length===0){
        gridHTML += `<div class="wg-row"><div class="wg-cell">—</div>${joursRefs.map(()=>`<div class="wg-cell empty">Aucune</div>`).join('')}</div>`;
      }
      planningGrid.innerHTML = gridHTML;
    }

    /* Vider semaine */
    document.getElementById("viderSemaine").onclick = ()=>{
      const all = readAll();
      if (all[currentWeekKey]){
        if (confirm("Supprimer toutes les données de cette semaine ?")){
          delete all[currentWeekKey]; writeAll(all); renderAll();
        }
      } else alert("Aucune donnée pour cette semaine.");
    };

    renderAll();
  </script>
</body>
</html>

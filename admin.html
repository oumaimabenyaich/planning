<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Horaires — Ultra compact</title>
<style>
  :root{
    --bg:#fff; --text:#1f1f1f; --line:#ece7ee; --head:#f6eff8; --primary:#d81b60;
    --ok:#16a34a; --warn:#eab308; --no:#dc2626;
    --fs:13px; --fs-s:12px; --fs-xs:11px;
    --w-name:78px; --w-day:56px; --w-total:48px;
  }
  html,body{height:100%}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); font-size:var(--fs); -webkit-font-smoothing:antialiased}
  header{position:sticky; top:0; z-index:10; background:#fffccfff; background:#fff; border-bottom:1px solid var(--line)}
  .bar{display:flex; gap:.4rem; align-items:center; justify-content:center; padding:.5rem}
  .bar button{padding:.28rem .5rem; border-radius:999px; border:1px solid var(--primary); background:var(--primary); color:#fff; font-size:var(--fs-s)}
  h1{margin:.2rem 0 .4rem; text-align:center; font-size:16px; color:#6a1b9a}
  #info{margin:0 0 .6rem; text-align:center; color:#6b5b7a; font-size:var(--fs-s)}

  table{width:100%; border-collapse:collapse; table-layout:fixed}
  th,td{border:1px solid var(--line); padding:.32rem; text-align:center; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  th{background:var(--head); font-weight:700; font-size:var(--fs-s); color:#3b2b51}
  td{font-size:var(--fs-s)}
  th:first-child,td:first-child{width:var(--w-name)}
  th:last-child,td:last-child{width:var(--w-total)}
  th:not(:first-child):not(:last-child), td:not(:first-child):not(:last-child){width:var(--w-day)}

  .range{width:100%; padding:.2rem; font-size:var(--fs-xs); border:1px solid var(--line); border-radius:8px; background:#fff}
  .cell{display:grid; gap:.18rem}
  .badge{display:inline-block; padding:.08rem .35rem; border-radius:999px; font-size:10px; font-weight:700; border:1px solid transparent; cursor:pointer; user-select:none}
  .b-wait{background:#fff7cc; color:#5b4600; border-color:#f3e48a}
  .b-ok{background:#dbf7df; color:#0e5f1c; border-color:#a8e1b1}
  .b-no{background:#ffe1e1; color:#7b1212; border-color:#ffbaba}
  .total{font-weight:700}
  .hint{padding:.7rem; text-align:center; color:#7a6b87}
  .mini{font-size:10px; color:#8c7a99}
</style>
</head>
<body>

<header>
  <h1>Edition des horaires (compact)</h1>
  <div class="bar">
    <button id="prev">⟵</button>
    <button id="today">Cette semaine</button>
    <button id="next">⟶</button>
    <button id="clear">Vider</button>
  </div>
</header>

<p id="info" class="mini">Chargement…</p>

<table id="tbl">
  <thead>
    <tr>
      <th>Nom</th>
      <th>Lun</th><th>Mar</th><th>Mer</th><th>Jeu</th><th>Ven</th>
      <th>Tot</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<p id="empty" class="hint" style="display:none">Aucune donnée cette semaine.</p>

<script>
/* ===== Helpers ===== */
const pad = n => String(n).padStart(2,'0');
const hhmm = s => {const [h,m]=s.split(':').map(Number); return h*60+m;};
const dur = (r)=>{ if(!r||r==='--')return 0; const [a,b]=r.split('–'); return hhmm(b)-hhmm(a); };
const toHM = m => m<=0 ? '0h' : `${Math.floor(m/60)}h${(m%60)?pad(m%60):''}`;
function mondayOf(d){d=new Date(d); d.setHours(0,0,0,0); const wd=d.getDay(); d.setDate(d.getDate()+(wd===0?-6:1-wd)); return d;}
function addDays(d,n){const x=new Date(d); x.setDate(d.getDate()+n); return x;}
function addWeeks(d,n){return addDays(d,7*n);}
function keyFromMon(m){return `${m.getFullYear()}-${pad(m.getMonth()+1)}-${pad(m.getDate())}`;}
function labelWeek(m){const v=addDays(m,4); return `du ${m.toLocaleDateString('fr-FR')} au ${v.toLocaleDateString('fr-FR')}`;}

const DAYS = ["Lundi","Mardi","Mercredi","Jeudi","Vendredi"]; // clés data
const RANGES = ["--","10:00–12:00","10:00–13:00","10:30–13:00","11:00–13:00","11:00–13:30","12:00–13:30"];

const LS = "dispos_ultra_compact";
const readAll = ()=>{ try{return JSON.parse(localStorage.getItem(LS)||"{}");}catch{return{}} };
const writeAll = (o)=>localStorage.setItem(LS, JSON.stringify(o));

/* ===== State ===== */
let monday = mondayOf(new Date());
let weekKey = keyFromMon(monday);

/* ===== UI refs ===== */
const info = document.getElementById('info');
const tbody = document.querySelector('#tbl tbody');
const empty = document.getElementById('empty');

/* ===== Data shape =====
data[weekKey][user] = {
  prenom: "Laura",
  jours: { "Lundi":{range:"10:00–13:00", statut:"validé"}, ... }
}
*/

/* ===== Seed (optionnel) : décommente pour tester
let all = readAll();
all[weekKey] = {
  laura:{prenom:"Laura",jours:{}},
  adam:{prenom:"Adam",jours:{}}
}; writeAll(all);
*/

/* ===== Rendering ===== */
function refreshInfo(){
  info.textContent = labelWeek(monday);
}

function cycleStatut(s){
  if(s==="validé") return "refusé";
  if(s==="refusé") return "en-attente";
  return "validé";
}
function badgeClass(s){ return s==="validé"?"badge b-ok": s==="refusé"?"badge b-no":"badge b-wait"; }

function render(){
  refreshInfo();
  const all = readAll();
  const week = all[weekKey] || {};
  const keys = Object.keys(week).sort((a,b)=> (week[a].prenom||a).localeCompare(week[b].prenom||b,'fr',{sensitivity:'base'}));
  tbody.innerHTML = "";
  empty.style.display = keys.length? "none":"block";

  for(const k of keys){
    const rec = week[k]; const name = rec.prenom || k;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="font-weight:700">${name}</td>`;
    let total=0;

    for(const J of DAYS){
      const cell = document.createElement('td');
      const j = rec.jours?.[J] || {};
      const range = j.range || "--";
      const statut = j.statut || "en-attente";
      total += dur(range) && statut==="validé" ? dur(range) : 0;

      const sel = document.createElement('select');
      sel.className = "range";
      for(const r of RANGES){
        const opt = document.createElement('option');
        opt.value = r; opt.textContent = r; if(r===range) opt.selected=true;
        sel.appendChild(opt);
      }
      sel.onchange = ()=>{
        const all2 = readAll();
        all2[weekKey] ??= {};
        all2[weekKey][k] ??= {prenom:name, jours:{}};
        all2[weekKey][k].jours[J] ??= {};
        all2[weekKey][k].jours[J].range = sel.value;
        writeAll(all2);
        render();
      };

      const b = document.createElement('span');
      b.textContent = (statut==="validé"?"Validé": statut==="refusé"?"Refusé":"En attente");
      b.className = badgeClass(statut);
      b.onclick = ()=>{
        const all2 = readAll();
        all2[weekKey] ??= {};
        all2[weekKey][k] ??= {prenom:name, jours:{}};
        all2[weekKey][k].jours[J] ??= {};
        all2[weekKey][k].jours[J].statut = cycleStatut(all2[weekKey][k].jours[J].statut);
        writeAll(all2);
        render();
      };

      const wrap = document.createElement('div');
      wrap.className = "cell";
      wrap.appendChild(sel);
      wrap.appendChild(b);
      cell.appendChild(wrap);
      tr.appendChild(cell);
    }
    const tdTot = document.createElement('td');
    tdTot.className = "total";
    tdTot.textContent = toHM(total);
    tr.appendChild(tdTot);

    tbody.appendChild(tr);
  }
}

/* ===== Nav ===== */
document.getElementById('prev').onclick = ()=>{ monday=addWeeks(monday,-1); weekKey=keyFromMon(monday); render(); };
document.getElementById('next').onclick = ()=>{ monday=addWeeks(monday, 1); weekKey=keyFromMon(monday); render(); };
document.getElementById('today').onclick= ()=>{ monday=mondayOf(new Date()); weekKey=keyFromMon(monday); render(); };
document.getElementById('clear').onclick = ()=>{
  const all = readAll();
  if(all[weekKey] && confirm("Vider cette semaine (local) ?")){
    delete all[weekKey]; writeAll(all); render();
  }
};

render();
</script>
</body>
</html>

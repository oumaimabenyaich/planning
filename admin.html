<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Gestion des Horaires</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:Arial,sans-serif;padding:2rem;background:#faf7f9;color:#333;}
    h1{text-align:center;color:#6a1b9a;margin-bottom:.25rem;}
    #info-semaine{text-align:center;margin-bottom:1rem;color:#544a5d;}
    .toolbar{display:flex;gap:.5rem;justify-content:center;margin-bottom:1rem;}
    .toolbar button{padding:.5rem .9rem;border-radius:999px;border:1px solid #d81b60;background:#d81b60;color:#fff;cursor:pointer;}
    .toolbar button:hover{background:#a31447;}
    table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.08);border:1px solid #e9d7e5;}
    th,td{border:1px solid #e9d7e5;padding:.75rem;text-align:center;}
    th{background:#f3e3ee;color:#3c2a52;}
    select{padding:.45rem;border-radius:10px;border:1px solid #e9d7e5;}
    .statut{display:inline-block;padding:.25rem .5rem;border-radius:999px;font-size:.8rem;font-weight:bold;margin-top:.25rem;}
    .valid√©{background:#2e7d32;color:#fff;}
    .en-attente{background:#ffd54f;color:#4e3b00;}
    .refus√©{background:#c62828;color:#fff;}
    .action-btn{font-size:.8rem;margin:.2rem;padding:.35rem .6rem;border:none;border-radius:999px;cursor:pointer;color:#fff}
    .valider-btn{background:#2e7d32;}
    .refuser-btn{background:#c62828;}
    .total{font-weight:bold;}
    /* Planning grille */
    .planning{margin-top:2rem;}
    .wg-row{display:grid;grid-template-columns:180px repeat(5,1fr);}
    .wg-row.header{background:#f3e3ee;font-weight:bold;color:#3c2a52;}
    .wg-cell{border:1px solid #eadff0;padding:.6rem;min-height:46px;background:#faf8fc;display:flex;align-items:center;justify-content:center;}
    .wg-row .wg-cell:first-child{background:#fff;justify-content:flex-start;padding-left:.8rem;}
    .pill{background:#c8e6c9;border:1px solid #81c784;padding:.25rem .55rem;border-radius:8px;font-weight:600;color:#1b5e20;white-space:nowrap;}
    .empty{color:#8b7f92;font-style:italic;}
    @media print{ .toolbar, table, h1, #info-semaine {display:none!important;} body{padding:0;} }
  </style>
</head>
<body>
  <h1>Tableau Admin</h1>
  <div class="toolbar">
    <button id="prevWeek">‚üµ Semaine pr√©c√©dente</button>
    <button id="thisWeek">Cette semaine</button>
    <button id="nextWeek">Semaine suivante ‚ü∂</button>
  </div>
  <p id="info-semaine">üìÖ</p>

  <table id="tableau">
    <thead>
      <tr><th>Pr√©nom</th><th>Lundi</th><th>Mardi</th><th>Mercredi</th><th>Jeudi</th><th>Vendredi</th><th>Total valid√©</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <section class="planning">
    <h2 style="color:#6a1b9a;margin-bottom:.5rem;">Planning valid√©</h2>
    <div id="planning-grid"></div>
  </section>

  <script type="module">
    import { db, initAuth } from './firebase.js';
    import { collection, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    await initAuth;

    const jours=["Lundi","Mardi","Mercredi","Jeudi","Vendredi"];
    const heures=["--"]; for(let h=10;h<=13;h++){for(let m of [0,15,30,45]){if(h===13&&m>30)break;heures.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`)}}

    // dates / semaine
    function mondayOf(d){const x=new Date(d);x.setHours(0,0,0,0);const day=x.getDay();const diff=(day===0?-6:1-day);x.setDate(x.getDate()+diff);return x;}
    function addWeeks(d,n){const x=new Date(d);x.setDate(x.getDate()+7*n);return x;}
    function weekKeyFromMonday(mon){return `${mon.getFullYear()}-${String(mon.getMonth()+1).padStart(2,'0')}-${String(mon.getDate()).padStart(2,'0')}`;}
    function labelSemaine(mon){const ven=new Date(mon);ven.setDate(mon.getDate()+4);return `üìÖ du ${mon.toLocaleDateString('fr-FR')} au ${ven.toLocaleDateString('fr-FR')}`;}
    const pad=n=>String(n).padStart(2,'0'); const hhmmToMin=s=>{const [h,m]=s.split(":").map(Number);return h*60+m;}; const toHM=m=>`${Math.floor(m/60)} h${m%60?(" "+pad(m%60)):""}`.replace(" 00","");

    let currentMonday=mondayOf(new Date());
    let currentWeekKey=weekKeyFromMonday(currentMonday);
    const info=document.getElementById("info-semaine");
    const tbody=document.querySelector("#tableau tbody");
    const planningGrid=document.getElementById("planning-grid");

    document.getElementById("prevWeek").onclick=()=>{currentMonday=addWeeks(currentMonday,-1);currentWeekKey=weekKeyFromMonday(currentMonday);renderAll();};
    document.getElementById("nextWeek").onclick=()=>{currentMonday=addWeeks(currentMonday, 1);currentWeekKey=weekKeyFromMonday(currentMonday);renderAll();};
    document.getElementById("thisWeek").onclick=()=>{currentMonday=mondayOf(new Date());currentWeekKey=weekKeyFromMonday(currentMonday);renderAll();};

    function calculHeure(d,f){ if(!d||!f||d==="--"||f==="--") return 0; return hhmmToMin(f)-hhmmToMin(d); }
    function selectHTML(value){ return heures.map(h=>`<option value="${h}" ${h===value?'selected':''}>${h}</option>`).join(''); }

    // d√©l√©gation √©v√©nements
    tbody.addEventListener("change", async (e)=>{
      const sel=e.target;
      if(!sel.matches("select[data-role]")) return;
      const role=sel.dataset.role, key=sel.dataset.user, jour=sel.dataset.jour;
      const ref=doc(db,"disponibilites",currentWeekKey,"users",key);
      const snap=await getDoc(ref); if(!snap.exists()) return;
      const data=snap.data(); const j= data[jour] || { statut:"en-attente" };
      j[role]=sel.value; data[jour]=j;
      await updateDoc(ref,{ [jour]: j, updatedAt: Date.now() });
      renderAll();
    });

    tbody.addEventListener("click", async (e)=>{
      const vb=e.target.closest(".valider-btn"); const rb=e.target.closest(".refuser-btn");
      if(!vb && !rb) return;
      const key=(vb||rb).dataset.user; const jour=(vb||rb).dataset.jour;
      const ref=doc(db,"disponibilites",currentWeekKey,"users",key);
      const snap=await getDoc(ref); if(!snap.exists()) return;
      const j = snap.data()[jour] || {};
      j.statut = vb ? "valid√©" : "refus√©";
      await updateDoc(ref,{ [jour]: j, updatedAt: Date.now() });
      renderAll();
    });

    async function renderAll(){
      info.textContent = labelSemaine(currentMonday);
      tbody.innerHTML="";

      const col=collection(db,"disponibilites",currentWeekKey,"users");
      const snap=await getDocs(col);
      const entries=[]; snap.forEach(d=>entries.push({ id:d.id, ...d.data() }));
      entries.sort((a,b)=> (a.prenom||a.id).localeCompare(b.prenom||b.id,'fr',{sensitivity:'base'}));

      for(const rec of entries){
        let total=0;
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${rec.prenom||rec.id}</td>`;
        for(const j of jours){
          const h=rec[j];
          const cell=document.createElement("td");
          const debut=h?.debut||"--", fin=h?.fin||"--", statut=h?.statut||"en-attente";
          if (statut==="valid√©") total += calculHeure(debut,fin);
          cell.innerHTML = `
            <div>
              <select data-role="debut" data-user="${rec.id}" data-jour="${j}">${selectHTML(debut)}</select>
              <select data-role="fin" data-user="${rec.id}" data-jour="${j}">${selectHTML(fin)}</select>
            </div>
            <div class="statut ${statut}">${statut}</div>
            <button class="action-btn valider-btn" data-user="${rec.id}" data-jour="${j}">Valider</button>
            <button class="action-btn refuser-btn" data-user="${rec.id}" data-jour="${j}">Refuser</button>
          `;
          tr.appendChild(cell);
        }
        tr.innerHTML += `<td class="total">${toHM(total)}</td>`;
        tbody.appendChild(tr);
      }

      // planning valid√© (grille)
      let gridHTML = `<div class="wg-row header"><div class="wg-cell">Nom</div>${jours.map(j=>`<div class="wg-cell">${j}</div>`).join('')}</div>`;
      for(const rec of entries){
        gridHTML += `<div class="wg-row"><div class="wg-cell">${rec.prenom||rec.id}</div>${
          jours.map(j=>{
            const h=rec[j];
            if(h?.statut==="valid√©" && h.debut && h.fin) return `<div class="wg-cell"><span class="pill">${h.debut}‚Äì${h.fin}</span></div>`;
            return `<div class="wg-cell"><span class="empty"></span></div>`;
          }).join('')
        }</div>`;
      }
      planningGrid.innerHTML = gridHTML;
    }

    renderAll();
  </script>
</body>
</html>
